!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function extend(r){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_len>_key;_key++)args[_key-1]=arguments[_key];return args.forEach(function(o){if((0,_instanceOf2["default"])(r,Object)&&(0,_instanceOf2["default"])(o,Object)&&r!==o)for(var x in o)r[x]=extend(r[x],o[x]);else r=o}),r}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=extend;var _instanceOf=require("./instanceOf.js"),_instanceOf2=_interopRequireDefault(_instanceOf)},{"./instanceOf.js":2}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=function(test,root){return root&&test instanceof root}},{}],3:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function on(evt,callback){var _this2=this;return callback&&"function"==typeof callback&&evt.split(separator).forEach(function(name){_this2.events[name]=[callback].concat(_this2.events[name]||[])}),this}function off(evt,callback){return this.findEvents(evt,function(name,index){callback&&this.events[name][index]!==callback||(this.events[name][index]=null)}),this}function emit(evt){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_len>_key;_key++)args[_key-1]=arguments[_key];args.push(evt);for(var handler=function(name,index){args[args.length-1]="*"===name?evt:name,this.events[name][index].apply(this,args)},_this=this;_this&&_this.findEvents;)_this.findEvents(evt+",*",handler),_this=_this.parent;return this}function emitAfter(){var _this=this,args=arguments;return(0,_setImmediate2["default"])(function(){_this.emit.apply(_this,args)}),this}function findEvents(evt,callback){var a=evt.split(separator);for(var name in this.events)this.events.hasOwnProperty(name)&&a.indexOf(name)>-1&&this.events[name].forEach(triggerCallback.bind(this,name,callback))}function triggerCallback(name,callback,handler,i){handler&&callback.call(this,name,i)}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=function(){return this.parent={events:this.events,findEvents:this.findEvents,parent:this.parent,utils:this.utils},this.events={},this.off=off,this.on=on,this.emit=emit,this.emitAfter=emitAfter,this.findEvents=findEvents,this};var _setImmediate=require("../time/setImmediate.js"),_setImmediate2=_interopRequireDefault(_setImmediate),separator=/[\s\,]+/},{"../time/setImmediate.js":4}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=window.setImmediate||function(cb){return setTimeout(cb,0)}},{}],5:[function(require,module,exports){"use strict";define(["../utils/PeerConnection"],function(PeerConnection){var pc,channel;try{pc=new PeerConnection({iceServers:[{url:"stun:localhost"}]}),channel=pc.createDataChannel("supportCheck",{reliable:!1}),channel.close(),pc.close()}catch(e){}return{rtc:!!pc,datachannel:!!channel}})},{}],6:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _pubsub=require("tricks/object/pubsub"),_pubsub2=_interopRequireDefault(_pubsub),_extend=require("tricks/object/extend"),_extend2=_interopRequireDefault(_extend),_featureDetect=require("./lib/featureDetect"),_featureDetect2=_interopRequireDefault(_featureDetect),_socket=require("./models/socket"),_socket2=_interopRequireDefault(_socket),_presence=require("./models/presence"),_presence2=_interopRequireDefault(_presence),_threads=require("./models/threads"),_threads2=_interopRequireDefault(_threads),_stream=require("./models/stream"),_files=(_interopRequireDefault(_stream),require("./models/files")),_localmedia=(_interopRequireDefault(_files),require("./models/localmedia")),STUN_SERVER=(_interopRequireDefault(_localmedia),"stun:stun.l.google.com:19302"),peer=Object.create(new _pubsub2["default"]);(0,_extend2["default"])(peer,{stun_server:STUN_SERVER,support:_featureDetect2["default"]}),window.peer=peer,_socket2["default"].call(peer),_presence2["default"].call(peer),_threads2["default"].call(peer),Streams.call(peer),LocalMedia.call(peer),window.addEventListener("beforeunload",function(){peer.disconnect()})},{"./lib/featureDetect":5,"./models/files":7,"./models/localmedia":8,"./models/presence":9,"./models/socket":10,"./models/stream":11,"./models/threads":12,"tricks/object/extend":1,"tricks/object/pubsub":3}],7:[function(require,module,exports){"use strict";define([],function(){return function(){var self=this,chunkLength=1e3;this.sendFile=function(file,to){function onReadAsDataURL(event,text,index){event&&(text=event.target.result),data.index=+index||0,text.length>chunkLength?data.message=text.slice(0,chunkLength):(data.message=text,data.last=!0),self.send(data);var remainingDataURL=text.slice(data.message.length);remainingDataURL.length&&setTimeout(function(){onReadAsDataURL(null,remainingDataURL)},500)}var reader=new window.FileReader;reader.onload=onReadAsDataURL,reader.readAsDataURL(file);var data={to:to,type:"file:progress"}};var files={};this.on("file:progress",function(data){files[data.id]=files[data.id]||[],files[data.id][data.index]=data.message})}})},{}],8:[function(require,module,exports){"use strict";define(["../utils/getUserMedia"],function(getUserMedia){return function(){this.localmedia=null,this.addMedia=function(successHandler,failHandler){var self=this,_success=function(stream){self.localmedia=stream,stream.addEventListener("ended",function(){self.localmedia&&self.localmedia!==stream||(self.emit("localmedia:disconnect",stream),self.localmedia=null)}),successHandler&&successHandler(stream),self.emit("localmedia:connect",stream)};return successHandler instanceof EventTarget?(_success(successHandler),this):this.localmedia?(successHandler&&successHandler(this.localmedia),this):(getUserMedia({audio:!0,video:!0},_success,function(e){self.emit("localmedia:failed",e),failHandler()}),this)}}})},{}],9:[function(require,module,exports){"use strict";define(function(){return function(){this.tag=function(data){return data instanceof Array||(data=[data]),this.send("presence:tag",{data:data}),this},this.watch=function(data){return data instanceof Array||(data=[data]),this.send("presence:watch",{to:data}),this}}})},{}],10:[function(require,module,exports){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj};define(["../utils/getScript"],function(getScript){var callbacks=[];return function(){var self=this;this.init=function(ws,callback){var connected,onload=function(){connected||(connected=!1,socket=io.connect(ws),console.log(socket.socket.sessionid),socket.on("message",function(data){if(data=JSON.parse(data),"callback_response"in data){var i=data.callback_response;return delete data.callback_response,void callbacks[i](data)}self.emit.call(self,data.type,data,function(o){"callback_id"in data&&(o.to=data.from,o.callback_response=data.callback_id,socket.send(JSON.stringify(o)))})}))};return"undefined"==typeof io&&getScript((ws||"")+"/socket.io/socket.io.js",onload),callback&&this.one("socket:connect",callback),this},this.disconnect=function(){socket&&socket.disconnect()},this.send=function(name,data,callback){"object"===("undefined"==typeof name?"undefined":_typeof(name))?(callback=data,data=name,name=data.type):data.type=name;callback&&(data.callback_id=callbacks.length,callbacks.push(callback));var action=function(){console.log("sending:",data),socket.send(JSON.stringify(data))};return this.id?action():self.one("socket:connect",action),this},self.one("socket:connect",function(e){self.id=e.id})}})},{}],11:[function(require,module,exports){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj};define(["../utils/PeerConnection","../utils/RTCSessionDescription","../utils/extend","../utils/merge","../utils/isEqual","../utils/events"],function(PeerConnection,RTCSessionDescription,extend,merge,isEqual,Events){function Stream(id,constraints,STUN_SERVER,peer){function operation(func){if(func?operations.push(func):console.log("STATE:",pc.signalingState),"stable"===pc.signalingState){var op=operations.shift();op&&op()}else console.log("PENDING:",operations)}function errorHandler(e){console.error("SET Description failed triggered:",e)}function setupDataChannel(channel){console.debug("DATACHANNEL CREATED",channel),channel.onopen=function(e){stream.emit("channel:connect",{type:"channel:connect",id:id,from:id,to:peer.id,target:e})},channel.onmessage=function(e){var data=JSON.parse(e.data);data.from=id,data.to=peer.id,data.target=e,stream.emit("channel:message",data)},channel.onerror=function(e){e.id=id,stream.emit("channel:error",e)}}function toggleLocalStream(){if(!pc||"closed"===pc.readyState)return void console.log("PC:connection closed, can't add stream");if(!stream.constraints.local.video||!stream.constraints.remote.video||!media)return void pc.getLocalStreams().forEach(function(media){operation(function(){console.log("PC:removing local media",media),pc.removeStream(media)})});console.log("PC:adding local media");var exit=!1;pc.getLocalStreams().forEach(function(_media){media===_media&&(exit=!0)}),exit||(operation(function(){console.log("Adding local stream"),pc.addStream(media)}),media.addEventListener("addtrack",function(e){console.log(e)}),media.addEventListener("removetrack",function(e){console.log(e)}))}var pc,operations=[],stream=new Events,MASTER=id<peer.id;stream.channel=null,stream.constraints={remote:{},local:{}},stream.setConstraints=function(constraints){var changed;constraints.local&&!isEqual(stream.constraints.local,constraints.local)&&(changed=!0),extend(stream.constraints,constraints||{}),console.log(stream.constraints),toggleLocalStream(),changed&&peer.send({type:"stream:constraints",remote:stream.constraints.local,to:id})},stream.on("stream:disconnected",function(){stream.remotemedia&&(stream.emit("media:disconnect",stream.remotemedia),stream.one("stream:connected",function(){stream.emit("media:connect",stream.remotemedia)}))});var pc_config={iceServers:[{url:STUN_SERVER}]},pc_constraints={optional:[{DtlsSrtpKeyAgreement:!0}]};try{stream.pc=pc=new PeerConnection(pc_config,pc_constraints),pc.onicecandidate=function(e){var candidate=e.candidate;candidate&&peer.send({type:"stream:candidate",data:{label:candidate.label||candidate.sdpMLineIndex,candidate:candidate.toSdp?candidate.toSdp():candidate.candidate},to:id})}}catch(e){return console.error("PeerJS: Failed to create PeerConnection, exception: "+e.message),stream}return pc.onsignalingstatechange=function(e){operation()},pc.oniceconnectionstatechange=function(e){console.warn("ICE-CONNECTION-STATE-CHANGE "+pc.iceConnectionState),stream.emit("stream:"+pc.iceConnectionState,{from:id})},pc.onaddstream=function(e){e.from=id,stream.emit("media:connect",e),stream.remotemedia=e,toggleLocalStream()},pc.onremovestream=function(e){remotemedia=null,e.from=id,stream.emit("media:disconnect",e),toggleLocalStream()},pc.ondatachannel=function(e){stream.channel=e.channel,setupDataChannel(e.channel)},pc.onnegotiationneeded=function(e){return"closed"===pc.signalingState?void console.warn("signallingState closed"):void(MASTER?pc.createOffer(function(session){operation(function(){pc.setLocalDescription(session,function(){peer.send({type:"stream:offer",to:id,data:pc.localDescription})},errorHandler)})},null,config):peer.send({type:"stream:makeoffer",to:id}))},stream.addStream=function(_media){media=_media,toggleLocalStream()},stream.removeStream=function(){media=null,toggleLocalStream()},stream.open=function(offer){offer?pc.setRemoteDescription(new RTCSessionDescription(offer),function(){return"closed"===pc.signalingState?void console.warn("signalingState closed: during setRemoteDescription"):void pc.createAnswer(function(session){return console.log("pc.signalingState",pc.signalingState),"closed"===pc.signalingState?void console.warn("signalingState closed: after createAnswer"):void pc.setLocalDescription(session,function(){peer.send({type:"stream:answer",to:id,data:pc.localDescription})},errorHandler)},null,config)}):MASTER&&!stream.channel?(stream.channel=pc.createDataChannel("data"),setupDataChannel(stream.channel)):operation(pc.onnegotiationneeded)},stream}var media,default_constraints={video:!1},config={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};return function(){this.streams={},this.stream=function(id,constraints,offer){if(console.log("stream",arguments),!id)throw"streams(): Expecting an ID";var stream=this.streams[id];return stream?(constraints?stream.setConstraints(constraints):void 0!==offer&&stream.open(offer),stream):(stream=this.streams[id]=Stream(id,constraints,this.stun_server,this),constraints&&stream.setConstraints(constraints),stream.on("*",this.emit.bind(this)),this.on("localmedia:connect",stream.addStream),this.on("localmedia:disconnect",stream.removeStream),this.localmedia&&stream.addStream(this.localmedia),stream.open(offer||null),stream)};var socketSend=this.send;this.send=function(name,data,callback){"object"===("undefined"==typeof name?"undefined":_typeof(name))&&(callback=data,data=name,name=data.type);var recipient=data.to,stream=this.streams[recipient];if(recipient&&stream&&stream.channel&&"open"===stream.channel.readyState){name&&(data.type=name);var str=JSON.stringify(data);try{return void stream.channel.send(str)}catch(e){stream.channel=null,this.stream(recipient,null,null)}}socketSend.call(this,name,data,callback)},this.on("stream:connect, stream:change, stream:constraints",function(e){var constraints={};e.remote&&(constraints.remote=merge(default_constraints,e.remote)),e.local&&!e.from&&(constraints.local=merge(default_constraints,e.local)),this.stream(e.from||e.id,constraints)}),this.on("stream:offer, stream:makeoffer",function(e){this.stream(e.from,null,e.data||null)}),this.on("stream:answer",function(e){console.log("on:answer: Answer recieved, connection created"),this.streams[e.from].pc.setRemoteDescription(new RTCSessionDescription(e.data))}),this.on("stream:candidate",function(e){var uid=e.from,data=e.data,stream=this.streams[uid];if(!stream)return void console.error("Candidate needs initiation");var candidate=new RTCIceCandidate({sdpMLineIndex:data.label,candidate:data.candidate});try{stream.pc.addIceCandidate(candidate)}catch(err){console.error("Failed to set iceCandidate"),console.error(candidate),console.error(err)}}),this.on("localmedia:disconnect",function(mediastream){for(var x in this.streams)this.streams[x].pc.removeStream(mediastream)}),this.on("channel:connect",function(e){}),this.on("channel:message",function(data){if("callback_response"in data){var i=data.callback_response;return delete data.callback_response,void this.callback[i].call(peer,data)}var type=data.type;this.emit(type,data,function(o){"callback"in data&&(o.to=data.from,o.callback_response=data.callback,this.send(o))})})}})},{}],12:[function(require,module,exports){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj};define(["../utils/extend"],function(extend){function Thread(id){this.id=id,this.constraints={},this.streams={},this.state="connect"}function extendProperties(a,b){if(b)for(var constraint in b){var value=b[constraint];value&&(a[constraint]=value)}}return function(){function updatePeerConnection(remoteID){var local={},remote={};for(var threadId in this.threads){var thread=this.threads[threadId],streams=thread.streams;remoteID in streams&&(extendProperties(remote,streams[remoteID]),extendProperties(local,thread.constraints))}this.emit("stream:change",{id:remoteID,local:local,remote:remote})}this.threads={},this.thread=function(id,constraints){"object"!==("undefined"==typeof id?"undefined":_typeof(id))&&id||(constraints||(constraints=id||{}),id=(1e18*Math.random()).toString(36));var type,thread=this.threads[id];if(thread?constraints?(thread.constraints||(thread.constraints={}),extend(thread.constraints,constraints),type="thread:change"):constraints===!1&&(thread.constraints=!1,type="thread:disconnect"):(thread=this.threads[id]=new Thread(id),thread.constraints=constraints||{},type="thread:connect"),type){var data={thread:id};constraints&&(data.constraints=thread.constraints),this.send(type,data),this.emit(type,data)}return thread},this.on("thread:connect, thread:change",function(e){var remoteID=e.from;if(console.log("thread:change",e),!e.thread)throw Error("thread:* event fired without a thread value");var thread=this.thread(e.thread);if(remoteID){if(remoteID in thread.streams?extend(thread.streams[remoteID],e.constraints||{}):thread.streams[remoteID]=e.constraints||{},updatePeerConnection.call(this,remoteID),!e.to){var data={to:remoteID,thread:thread.id,constraints:thread.constraints};console.log("SEND",JSON.stringify(data)),this.send("thread:connect",data)}}else for(remoteID in thread.streams)updatePeerConnection.call(this,remoteID)}),this.on("thread:disconnect",function(e){var remoteID,thread=this.threads[e.thread];if("from"in e)remoteID=e.from,remoteID in thread.streams&&(delete thread.streams[remoteID],updatePeerConnection.call(this,remoteID));else for(remoteID in threads.stream)updatePeerConnection.call(this,remoteID)})}})},{}]},{},[6]);
//# sourceMappingURL=peer.js.map
